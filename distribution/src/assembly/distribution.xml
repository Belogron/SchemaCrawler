<?xml version="1.0" encoding="UTF-8"?>
<project name="schemacrawler" default="make-distribution" basedir=".">

	<property name="distribution.assembly" location="${SchemaCrawler.home}/distribution/src/assembly"/>
	<property name="distribution.target" location="${SchemaCrawler.home}/distribution/target"/>

	<target
	  name="make-distribution"
	  depends="make-super-jar,make-binary-distribution,make-source-distribution,make-database-distributions,cleanup-distribution"
	  description="Package all sub-project jars into the distributable jar"/>


	<target name="make-super-jar">

		<property name="schemacrawler.super.jar" value="${distribution.target}/schemacrawler-${SchemaCrawler.version}.jar"/>
		<jar destfile="${schemacrawler.super.jar}" duplicate="preserve" index="true">
			<manifest>
				<attribute name="Product" value="SchemaCrawler"/>
				<attribute name="Version" value="${SchemaCrawler.version}"/>
				<attribute name="Author" value="Sualeh Fatehi sualeh@hotmail.com"/>
				<attribute name="Copyright" value="(c) 2003-2009, Sualeh Fatehi"/>
				<attribute name="Main-Class" value="schemacrawler.Main"/>
			</manifest>
			<zipfileset dir="${SchemaCrawler.home}/schemacrawler/target/classes"/>
			<zipfileset dir="${SchemaCrawler.home}/schemacrawler-tools/target/classes"/>
			<zipfileset dir="${SchemaCrawler.home}/schemacrawler-integrations/target/classes"/>
			<zipfileset dir="${SchemaCrawler.home}/schemacrawler-maven-plugin/target/classes"/>
		</jar>

  </target>


	<target name="make-binary-distribution">

	  <property name="distribution.dir" location="${distribution.target}/_distribution"/>
		<delete dir="${distribution.dir}"/>
		<mkdir dir="${distribution.dir}/examples"/>

    <!-- Copy super-jar -->
		<copy todir="${distribution.dir}/examples">
			<fileset dir="${distribution.target}">
				<include name="schemacrawler-${SchemaCrawler.version}.jar"/>
			</fileset>
		</copy>

		<!-- Get licenses -->
		<get
      src="http://www.gnu.org/licenses/lgpl-3.0.txt"
      dest="${distribution.dir}/examples/LICENSE.txt"
      verbose="true"
      usetimestamp="false" />
		<get
      src="http://hsqldb.org/web/hsqlLicense.html"
      dest="${distribution.dir}/examples/hsqlLicense.html"
      verbose="true"
      usetimestamp="false" />

		<!-- Copy config files -->
		<copy todir="${distribution.dir}/examples">
			<fileset dir="${SchemaCrawler.home}/schemacrawler/src/main/resources">
				<include name="*config.properties"/>
			</fileset>
			<fileset dir="${SchemaCrawler.home}/schemacrawler-integrations/src/test/resources">
				<include name="*.xml"/>
			</fileset>
		</copy>

		<!-- Copy examples -->
		<mkdir dir="${SchemaCrawler.home}/distribution/target/site/examples"/>
		<copy todir="${distribution.dir}/examples">
			<fileset dir="${SchemaCrawler.home}/distribution/target/site/examples"/>
		</copy>
		<copy file="${SchemaCrawler.home}/schemacrawler-test/src/main/java/ApiExample.java" todir="${distribution.dir}/examples/api"/>

		<!-- Copy database server -->
    <get
      src="http://www.ibiblio.org/maven/hsqldb/jars/hsqldb-1.8.0.7.jar"
      dest="hsqldb.jar"
      verbose="true"
      usetimestamp="true" />
    <copy file="hsqldb.jar" todir="${distribution.dir}/examples"/>

    <!-- Create shortcuts -->
		<copy todir="${distribution.dir}/examples">
			<fileset dir="${SchemaCrawler.home}/distribution/src/other"/>
		</copy>
		<copy todir="${distribution.dir}/schemacrawler/lib">
			<fileset dir="${distribution.target}">
				<include name="schemacrawler-${SchemaCrawler.version}.jar"/>
			</fileset>
		</copy>
		<filter token="version" value="${SchemaCrawler.version}"/>
		<filter token="package" value="schemacrawler"/>
		<copy todir="${distribution.dir}/schemacrawler" filtering="true">
			<fileset dir="${distribution.assembly}">
				<include name="*.cmd"/>
				<include name="*.sh"/>
				<include name="*.wsf"/>
			</fileset>
			<fileset dir="${SchemaCrawler.home}/distribution">
				<include name="README.txt"/>
			</fileset>
			<fileset dir="${distribution.dir}/examples">
				<include name="LICENSE.txt"/>
			</fileset>
		</copy>

		<!-- Create zip files for distribution -->
		<mkdir dir="${SchemaCrawler.home}/schemacrawler-tools/target/site"/>
		<mkdir dir="${SchemaCrawler.home}/schemacrawler/target/site"/>
		<property name="site.zip.prefix" value="schemacrawler-${SchemaCrawler.version}-site"/>
		<delete file="${distribution.target}/${site.zip.prefix}.zip"/>
		<zip destfile="${distribution.target}/${site.zip.prefix}.zip">
			<zipfileset dir="${SchemaCrawler.home}/schemacrawler-tools/target/site" prefix="${site.zip.prefix}" defaultexcludes="yes">
				<exclude name="apidocs/**/*"/>
			</zipfileset>
			<zipfileset dir="${SchemaCrawler.home}/schemacrawler/target/site" prefix="${site.zip.prefix}" defaultexcludes="yes">
				<include name="apidocs/**/*"/>
			</zipfileset>
		</zip>
		<property name="distribution.zip.prefix" value="schemacrawler-${SchemaCrawler.version}-distrib"/>
		<delete file="${distribution.target}/${distribution.zip.prefix}.zip"/>
		<zip destfile="${distribution.target}/${distribution.zip.prefix}.zip">
			<zipfileset dir="${distribution.dir}" prefix="${distribution.zip.prefix}" defaultexcludes="yes"/>
		</zip>

		<delete dir="${distribution.dir}"/>

  </target>


	<target name="make-source-distribution">

		<property name="source.zip.prefix" value="schemacrawler-${SchemaCrawler.version}-src"/>
		<delete file="${distribution.target}/${source.zip.prefix}.zip"/>
		<zip destfile="${distribution.target}/${source.zip.prefix}.zip">
			<zipfileset dir="${SchemaCrawler.home}" prefix="${source.zip.prefix}" defaultexcludes="yes">
				<exclude name="${distribution.target}"/>
				<exclude name="${distribution.target}/*"/>
				<exclude name="**/target"/>
				<exclude name="**/target/**/*"/>
				<exclude name="differencer"/>
				<exclude name="differencer/**/*"/>
				<exclude name="**/*.launch"/>
				<exclude name="**/*.log"/>
				<exclude name="**/*.lck"/>
				<exclude name="**/*.ser"/>
				<exclude name="*.html"/>
			</zipfileset>
		</zip>

	</target>


	<target name="make-database-distributions">

		<create-database-distrib database="mysql"/>
		<create-database-distrib database="postgresql"/>
		<create-database-distrib database="sqlserver"/>

	</target>


	<target name="cleanup-distribution">

		<delete>
			<fileset dir="${distribution.target}">
				<include name="*.*"/>
				<exclude name="schemacrawler*.zip"/>
			</fileset>
		</delete>

	</target>


	<macrodef name="create-database-distrib">
		<attribute name="database"/>

		<sequential>

			<move todir="${distribution.target}">
				<fileset dir="${SchemaCrawler.home}/schemacrawler-@{database}/target">
					<include name="schemacrawler-@{database}-${SchemaCrawler.version}-distrib.zip"/>
				</fileset>
			</move>

			<mkdir dir="${distribution.target}/@{database}-launches"/>

			<filter token="version" value="${SchemaCrawler.version}"/>
			<filter token="package" value="schemacrawler.tools.@{database}"/>
			<copy todir="${distribution.target}/@{database}-launches" filtering="true">
				<fileset dir="${distribution.assembly}">
					<include name="*.cmd"/>
					<include name="*.sh"/>
					<include name="*.wsf"/>
				</fileset>
			</copy>

			<zip destfile="${distribution.target}/schemacrawler-@{database}-${SchemaCrawler.version}-distrib.zip" update="true" whenempty="fail">
				<zipfileset dir="${distribution.target}/@{database}-launches" prefix="schemacrawler-@{database}-${SchemaCrawler.version}"/>
			</zip>

			<delete dir="${distribution.target}/@{database}-launches"/>

		</sequential>

	</macrodef>

</project>
