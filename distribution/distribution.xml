<?xml version="1.0" encoding="UTF-8"?>
<project name="schemacrawler" default="make-distribution" basedir=".">

	<property name="SchemaCrawlerHome" location=".."/>
	<property name="pom.version" value="6.1"/>

	<property name="distribution.assembly" location="${SchemaCrawlerHome}/distribution/src/assembly"/>
	<property name="distribution.target" location="${SchemaCrawlerHome}/distribution/target"/>

	<target
	  name="make-distribution"
	  depends="make-binary-distribution,make-source-distribution,make-database-distributions,cleanup-distribution"
	  description="Package all sub-project jars into the distributable jar"/>

	<target name="make-binary-distribution">

	  <property name="distribution.dir" location="${distribution.target}/_distribution"/>
		<delete dir="${distribution.dir}"/>
		<mkdir dir="${distribution.dir}/examples"/>

    <!-- Create super-jar -->
		<property name="distributable.jar" value="${distribution.dir}/examples/schemacrawler-${pom.version}.jar"/>
		<jar destfile="${distributable.jar}" duplicate="preserve" index="true">
			<manifest>
				<attribute name="Product" value="SchemaCrawler"/>
				<attribute name="Version" value="${pom.version}"/>
				<attribute name="Author" value="Sualeh Fatehi"/>
				<attribute name="Copyright" value="(c) 2003-2009, Sualeh Fatehi"/>
				<attribute name="Main-Class" value="schemacrawler.Main"/>
			</manifest>
			<zipfileset dir="${SchemaCrawlerHome}/schemacrawler/target/classes"/>
			<zipfileset dir="${SchemaCrawlerHome}/schemacrawler-tools/target/classes"/>
			<zipfileset dir="${SchemaCrawlerHome}/schemacrawler-integrations/target/classes"/>
			<zipfileset dir="${SchemaCrawlerHome}/schemacrawler-maven-plugin/target/classes"/>
		</jar>

		<!-- Copy licenses -->
		<copy todir="${distribution.dir}/examples">
			<fileset dir="${SchemaCrawlerHome}/schemacrawler">
				<include name="*README*.txt"/>
				<include name="*LICENSE*.txt"/>
				<include name="*NOTICE*.txt"/>
			</fileset>
		</copy>

		<!-- Copy config files -->
		<copy todir="${distribution.dir}/examples">
			<fileset dir="${SchemaCrawlerHome}/schemacrawler/src/main/resources">
				<include name="*.properties"/>
			</fileset>
		</copy>
		<copy todir="${distribution.dir}/examples">
			<fileset dir="${SchemaCrawlerHome}/schemacrawler-integrations/src/test/resources">
				<include name="*.xml"/>
			</fileset>
		</copy>

		<!-- Copy examples -->
		<mkdir dir="${SchemaCrawlerHome}/distribution/target/site/examples"/>
		<copy todir="${distribution.dir}/examples">
			<fileset dir="${SchemaCrawlerHome}/distribution/target/site/examples"/>
		</copy>
		<copy file="${SchemaCrawlerHome}/schemacrawler-test/src/main/java/ApiExample.java" todir="${distribution.dir}/examples/api"/>

		<!-- Copy database server -->
    <get
      src="http://www.ibiblio.org/maven/hsqldb/jars/hsqldb-1.8.0.7.jar"
      dest="hsqldb.jar"
      verbose="true"
      usetimestamp="true" />
    <copy file="hsqldb.jar" todir="${distribution.dir}/examples"/>

    <!-- Create shortcuts -->
		<copy todir="${distribution.dir}/examples">
			<fileset dir="${SchemaCrawlerHome}/distribution/src/other"/>
		</copy>
		<unzip src="${SchemaCrawlerHome}/distribution/target/distribution-${pom.version}-distrib.zip" dest="${distribution.dir}"/>
		<move todir="${distribution.dir}/schemacrawler">
			<fileset dir="${distribution.dir}/distribution-${pom.version}"/>
		</move>
		<filter token="version" value="${pom.version}"/>
		<filter token="package" value="schemacrawler"/>
		<copy todir="${distribution.dir}/schemacrawler" filtering="true">
			<fileset dir="${distribution.assembly}">
				<include name="*.cmd"/>
				<include name="*.sh"/>
				<include name="*.wsf"/>
			</fileset>
		</copy>

		<!-- Create zip files for distribution -->
		<mkdir dir="${SchemaCrawlerHome}/schemacrawler-tools/target/site"/>
		<mkdir dir="${SchemaCrawlerHome}/schemacrawler/target/site"/>
		<property name="site.zip.prefix" value="schemacrawler-${pom.version}-site"/>
		<delete file="${distribution.target}/${site.zip.prefix}.zip"/>
		<zip destfile="${distribution.target}/${site.zip.prefix}.zip">
			<zipfileset dir="${SchemaCrawlerHome}/schemacrawler-tools/target/site" prefix="${site.zip.prefix}" defaultexcludes="yes">
				<exclude name="apidocs/**/*"/>
			</zipfileset>
			<zipfileset dir="${SchemaCrawlerHome}/schemacrawler/target/site" prefix="${site.zip.prefix}" defaultexcludes="yes">
				<include name="apidocs/**/*"/>
			</zipfileset>
		</zip>
		<property name="distribution.zip.prefix" value="schemacrawler-${pom.version}-distrib"/>
		<delete file="${distribution.target}/${distribution.zip.prefix}.zip"/>
		<zip destfile="${distribution.target}/${distribution.zip.prefix}.zip">
			<zipfileset dir="${distribution.dir}" prefix="${distribution.zip.prefix}" defaultexcludes="yes"/>
		</zip>

		<delete dir="${distribution.dir}"/>

  </target>


	<target name="make-source-distribution">

		<property name="source.zip.prefix" value="schemacrawler-${pom.version}-src"/>
		<delete file="${distribution.target}/${source.zip.prefix}.zip"/>
		<zip destfile="${distribution.target}/${source.zip.prefix}.zip">
			<zipfileset dir="${SchemaCrawlerHome}" prefix="${source.zip.prefix}" defaultexcludes="yes">
				<exclude name="${distribution.target}"/>
				<exclude name="${distribution.target}/*"/>
				<exclude name="**/target"/>
				<exclude name="**/target/**/*"/>
				<exclude name="differencer"/>
				<exclude name="differencer/**/*"/>
				<exclude name="**/*.launch"/>
				<exclude name="**/*.log"/>
				<exclude name="**/*.lck"/>
				<exclude name="**/*.ser"/>
				<exclude name="*.html"/>
			</zipfileset>
		</zip>

	</target>


	<target name="make-database-distributions">

		<create-database-distrib database="mysql"/>
		<create-database-distrib database="postgresql"/>
		<create-database-distrib database="sqlserver"/>

	</target>


	<target name="cleanup-distribution">

		<delete>
			<fileset dir="${distribution.target}">
				<include name="*.*"/>
				<exclude name="schemacrawler*.zip"/>
			</fileset>
		</delete>

	</target>


	<macrodef name="create-database-distrib">
		<attribute name="database"/>

		<sequential>

			<move todir="${distribution.target}">
				<fileset dir="${SchemaCrawlerHome}/schemacrawler-@{database}/target">
					<include name="schemacrawler-@{database}-${pom.version}-distrib.zip"/>
				</fileset>
			</move>

			<mkdir dir="${distribution.target}/@{database}-launches"/>

			<filter token="version" value="${pom.version}"/>
			<filter token="package" value="schemacrawler.tools.@{database}"/>
			<copy todir="${distribution.target}/@{database}-launches" filtering="true">
				<fileset dir="${distribution.assembly}">
					<include name="*.cmd"/>
					<include name="*.sh"/>
					<include name="*.wsf"/>
				</fileset>
			</copy>

			<zip destfile="${distribution.target}/schemacrawler-@{database}-${pom.version}-distrib.zip" update="true" whenempty="fail">
				<zipfileset dir="${distribution.target}/@{database}-launches" prefix="schemacrawler-@{database}-${pom.version}"/>
			</zip>

			<delete dir="${distribution.target}/@{database}-launches"/>

		</sequential>

	</macrodef>

</project>
