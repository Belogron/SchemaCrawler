<?xml version="1.0"?>
<project name="snapshot" default="hsqldb">

  <description>Snapshot Ant Tasks and Macros</description>

  <property name="ant.file.snapshot" value="${ant.file}"/>
  <property name="schemacrawler.dir" value="../../_distrib"/>
  <property name="db-driver.dir" value="../../_distrib/dbserver"/>

  <typedef
    resource="schemacrawler-antlib.xml"
    classpath="${schemacrawler.dir}/schemacrawler-4.0.jar"/>

  <path id="db-driver-classpath">
    <fileset dir="${db-driver.dir}">
      <include name="*.jar"/>
    </fileset>
  </path>

  <target name="hsqldb">
      <tstamp prefix="start">
        <format property="filename.time" pattern="yyyy-MMM-dd-HHmm"/>
      </tstamp>
      <property name="outputfile-hsqldb" value="snapshots/${start.filename.time}-hsqldb.txt"/>
      <snapshot-db
        db-name="hsqldb"
        outputfile="${outputfile-hsqldb}"/>
  </target>

  <!-- = = = = = = = = = = = = = = = = = -->

  <macrodef name="snapshot-db" description="Makes a complete database snapshot">

    <attribute name="db-name"/>
    <attribute name="outputfile"/>

    <sequential>
      <mkdir dir="snapshots"/>

      <!-- SCHEMA: Tables, views, triggers, procedures -->
      <antcall target="-snapshot-schema">
        <param name="db-name" value="@{db-name}"/>
        <param name="outputfile" value="@{outputfile}"/>
      </antcall>

      <!-- DATA: Count and dump -->
      <antcall target="-snapshot-data">
        <param name="db-name" value="@{db-name}"/>
        <param name="outputfile" value="@{outputfile}"/>
      </antcall>

    </sequential>

  </macrodef>

  <target name="-snapshot-schema">

    <schemacrawler
      config="schemacrawler.config.properties"
      config-override="snapshot.config.properties"
      datasource="${db-name}"
      command="verbose_schema,hsqldb.views"
      outputfile="${outputfile}"
      outputformat="text"
      append="false"
      db-driver-classpath="db-driver-classpath"/>

  </target>

  <target name="-snapshot-data" unless="snapshot.schema_only">

    <schemacrawler
      config="schemacrawler.config.properties"
      config-override="dump.config.properties"
      datasource="${db-name}"
      command="count,dump"
      no-info="true"
      outputfile="${outputfile}"
      outputformat="csv"
      append="true"
      db-driver-classpath="db-driver-classpath"/>

  </target>

</project>
